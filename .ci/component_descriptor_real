#!/bin/bash

# SPDX-FileCopyrightText: 2020 SAP SE or an SAP affiliate company and Gardener contributors
#
# SPDX-License-Identifier: Apache-2.0

set -euo pipefail

PROJECT_ROOT="$(realpath $(dirname $0)/..)"
if [[ -z ${LOCALBIN:-} ]]; then
  LOCALBIN="$PROJECT_ROOT/bin"
fi

"$PROJECT_ROOT/.ci/ensure-make"

(
  cd "${PROJECT_ROOT}"

  echo "Fetch registry credentials ..."
  creds="$(cli.py config attribute --cfg-type container_registry --cfg-name laas-component-descriptor-pipeline --key password)"

  echo "Authenticate docker against artifact registry ..."
  docker login -u _json_key --password-stdin https://europe-docker.pkg.dev <<< "$creds"

  echo "Create OCM config ..."
  cat << EOF > "$HOME/.ocmconfig"
type: generic.config.ocm.software/v1
configurations:
  - type: credentials.config.ocm.software
    repositories:
      - repository:
          type: DockerConfig/v1
          dockerConfigFile: "~/.docker/config.json"
          propagateConsumerIdentity: true
EOF

  echo "Run 'make component-build' ..."
  make component-build
  echo "Component successfully built."

  echo "Run 'make component-push' ..."
  export OVERWRITE_COMPONENTS="true"
  make component-push
  echo "Component successfully pushed."
)
